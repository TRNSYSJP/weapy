# 暖房期間判定スクリプト

## 概要
拡張アメダス気象データを使用して、年間の暖房期間を自動判定し、気温データをインタラクティブなグラフで可視化するスクリプトです。

## 機能

### 1. 気象データの読み込み
- 拡張アメダス標準年（WEAファイル）から気象データを読み込み
- 時間単位の気温データを日次統計値（最高・平均・最低気温）に集計

### 2. データの平滑化
- 日次データに対して9日間の移動平均を3回適用
- 年末年始をまたぐ移動平均を計算するため、前後12日のデータを循環追加

### 3. 暖房期間の判定
判定基準:
- **判定温度**: 15℃（`HEATING_THRESHOLD_TEMP`で設定可能）
- **最寒日の特定**: 移動平均した平均気温が最も低い日
- **開始日の判定**: 最寒日から過去に遡り、判定温度を超えた日の翌日
- **終了日の判定**: 最寒日から未来に進み、判定温度を超えた日の前日

年をまたぐ暖房期間にも対応（例: 11月～翌年3月）

### 4. インタラクティブなグラフ生成
Plotlyを使用して以下の要素を含むHTMLチャートを生成:

#### データ系列
- 日次データ（最高・平均・最低気温）- 初期状態で非表示、凡例クリックで表示可能
- 移動平均データ（最高・平均・最低気温）- 初期表示

#### 視覚要素
- **暖房期間の背景**: 薄いオレンジ色で表示
- **暖房期間の境界線**: オレンジ色の細い実線（開始日・終了日）
- **最寒日・最暑日**: 黒色の点線
- **アノテーション**: 各重要日に吹き出しで日付を表示
  - Coldest Day（最寒日）
  - Hottest Day（最暑日）
  - Heating Start（暖房期間開始日）
  - Heating End（暖房期間終了日）

#### インタラクティブ機能
- レンジスライダーによる期間選択
- クロスヘアーカーソルでの値確認
- 凡例クリックでの系列表示/非表示切り替え

## 使用方法

### 必要な設定
スクリプト内の以下の変数を環境に合わせて設定:

```python
HEATING_THRESHOLD_TEMP = 15  # 暖房期間判定温度（℃）
WEATHER_DATA_YEAR = 2010     # 使用する気象データの年
no = 363                     # 地点番号（363: 東京）
elevation = 6.0              # 標高（m）
weafile = r'e:\EAD\RWY0110.wea'  # WEAファイルのパス
```

### 実行
```bash
python plot_heating_period.py
```

### 出力
- コンソール: 暖房期間判定結果の詳細情報
- ファイル: `heating_period_chart.html`（自動でブラウザで開かれる）

## 必要なパッケージ
- weapy（拡張アメダスデータ読み込み用）
- plotly（グラフ描画用）
- pandas（データ処理用）
- numpy（数値計算用）

```bash
pip install -r requirements.txt
```

## 出力例
```
データ長: 8760時間
使用する年: 2010年
データ期間: 2010-01-01 00:00:00 ~ 2010-12-31 23:00:00
データ数: 8760 時間

================================================================================
暖房期間の判定
================================================================================
最も気温の低い日: 2010-01-29 (1/29)
その日の気温: 5.23℃
最も気温の高い日: 2010-08-09 (8/9)
その日の気温: 29.45℃
暖房期間判定温度: 15℃

暖房期間開始日の判定（1/29から遡る）...
  11/29: 15.12℃ > 15℃
  → 暖房期間開始日: 2010-11-30 (11/30)

暖房期間終了日の判定（1/29から進む）...
  4/15: 15.08℃ > 15℃
  → 暖房期間終了日: 2010-04-14 (4/14)

【暖房期間】 2010-11-30 (11/30) ~ 2010-04-14 (4/14)
================================================================================
```

## ライセンス
Copyright quattro corporate design. All right reserved.

## 作成者
Yuichi Yasuda @ quattro corporate design
